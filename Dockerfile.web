# SD Thai Food - Frontend Dockerfile (Next.js)
# Build stage for frontend only

FROM node:20-alpine AS builder

WORKDIR /app

# Copy workspace configuration
COPY pnpm-workspace.yaml ./
COPY package.json pnpm-lock.yaml ./
COPY turbo.json ./

# Copy packages (needed for shared types/utils)
COPY packages/ ./packages/

# Copy frontend source
COPY apps/web/package.json ./apps/web/
COPY apps/web/ ./apps/web/

# Install pnpm
RUN npm install -g pnpm@8.15.4

# Install dependencies
RUN pnpm install --frozen-lockfile

# Generate Prisma client (needed for types)
RUN cd packages/prisma && pnpm db:generate

# Build frontend (standalone mode)
ARG NEXT_PUBLIC_API_URL=https://sdthai.secuaas.dev/api
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL

RUN cd apps/web && pnpm build

# Production stage with nginx
FROM nginx:alpine

# Copy custom nginx config
COPY --from=builder /app/apps/web/.next/standalone/apps/web/.next/static /usr/share/nginx/html/_next/static
COPY --from=builder /app/apps/web/public /usr/share/nginx/html

# Create nginx config
RUN echo 'server { \
    listen 80; \
    server_name _; \
    root /usr/share/nginx/html; \
    \
    location /_next/static { \
        alias /usr/share/nginx/html/_next/static; \
        expires 1y; \
        add_header Cache-Control "public, immutable"; \
    } \
    \
    location / { \
        proxy_pass http://api:3000; \
        proxy_http_version 1.1; \
        proxy_set_header Host $host; \
        proxy_set_header X-Real-IP $remote_addr; \
    } \
}' > /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
