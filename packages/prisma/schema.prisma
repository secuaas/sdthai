// SD Thai Food - Prisma Schema MVP
// Version simplifiée pour déploiement initial

generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PARTNER
  DRIVER
}

enum PartnerType {
  WITH_DELIVERY      // Partenaires avec livraison (paiement comptant)
  DEPOT_AUTOMATE     // Dépôts-vente et automates
}

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  DELIVERED
  CANCELLED
}

// ============================================
// CORE MODELS
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  role          UserRole
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  refreshTokens RefreshToken[]
  orders        Order[]

  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Partner {
  id                String      @id @default(uuid())
  name              String
  type              PartnerType
  email             String      @unique
  phone             String
  address           String
  paymentMethod     String      @default("CASH_TO_DRIVER")
  fixedDeliveryDays Json        // [1, 4] = Lundi, Jeudi
  canOrderViaAdmin  Boolean     @default(false)
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  orders Order[]

  @@map("partners")
}

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique
  barcode     String?  @unique
  nameFr      String
  description String?
  priceB2b    Decimal  @db.Decimal(10, 2)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems OrderItem[]

  @@index([sku])
  @@index([barcode])
  @@map("products")
}

model Order {
  id              String      @id @default(uuid())
  orderNumber     String      @unique
  partnerId       String
  partner         Partner     @relation(fields: [partnerId], references: [id])
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  status          OrderStatus @default(PENDING)
  requestedDate   DateTime
  isUrgent        Boolean     @default(false)
  urgentReason    String?
  urgentApproved  Boolean?
  subtotal        Decimal     @db.Decimal(10, 2)
  vatAmount       Decimal     @db.Decimal(10, 2)
  total           Decimal     @db.Decimal(10, 2)
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  items OrderItem[]

  @@index([partnerId])
  @@index([userId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}
